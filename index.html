<!DOCTYPE html>
<html>
	<head>
		<title>Welcome to Sockets i-mo</title>
	</head>
	<body class="main">
		<div id="game-screen">
			<div id="welcome"></div><input id="updateNameInput" placeholder="@whoAreYou?"> <button id="updateNameButton">Update Name</button>
			<hr />
			<div id="users" style="float:right;"></div>
			<canvas id="mo-canvas" width="900" height="600" style="border:1px solid #000000"></canvas>
		</div>
		<!-- Dress up this div and the buttons to make it look like an NES controller -->
		<div id="game-pad" style="display:none;">
			<button id="left">Left</button>
			<button id="right">Right</button>
			<button id="up">Up</button>
			<button id="down">Down</button>
		</div>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"> </script>
		<script type="text/javascript">
			window.onload = function() {
				if( /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
				 //hide pretty much everything but the game pad
				 	$("#game-screen").hide();
				 	$("#game-pad").show();
				 	$("#left").click(function(){
				 		socket.emit("onKeyPress", "left");
				 	});
				 	$("#right").click(function(){
				 		socket.emit("onKeyPress", "right");
				 	});
				 	$("#up").click(function(){
				 		socket.emit("onKeyPress", "up");
				 	});
				 	$("#down").click(function(){
				 		socket.emit("onKeyPress", "down");
				 	});
				}

				var c = document.getElementById("mo-canvas");
				var ctx = c.getContext("2d");
		        
				var welcome = document.getElementById("welcome");
				var allUsers = document.getElementById("users");
				var updateNameInput = document.getElementById("updateNameInput");
				var updateNameButton = document.getElementById("updateNameButton");
				var socket = io.connect(window.location.hostname);
				socket.on('welcome', function (data) {
					welcome.innerHTML = "Welcome  <strong>" + data['currentUser'].name + "</strong>";
			        allUsers.innerHTML = "<strong>Users:</strong><br />" + data.names;
				});
				socket.on('users', function (data) {
					allUsers.innerHTML = "<strong>Users:</strong><br />" + data.names;
				});
				socket.on('lose', function (data) {
					alert(data + "  loses!")
				});

				socket.on('draw', function (data) {
					ctx.clearRect(0, 0, c.width, c.height);
					for (var k = 0; k < data.cars.length; k+=1){
						ctx.beginPath();
						ctx.rect(data.cars[k].x, data.cars[k].y, 50, 50);
						ctx.fillStyle = 'blue';
      					ctx.fill();
					}

					for (var i = 0; i < data.users.length; i+=1){
						ctx.beginPath();
						ctx.rect(data.users[i].location.x, data.users[i].location.y, 50, 50);
						ctx.fillStyle = 'red';
      					ctx.fill();
      					ctx.font = "12px Arial";
						ctx.fillText(data.users[i].name,data.users[i].location.x,data.users[i].location.y);
					}
					
				});
			
				document.onkeydown = checkKey;
				function checkKey(e) {
				    e = e || window.event;
				    if (e.keyCode == '37') {
				        socket.emit("onKeyPress", "left");
				    }else if (e.keyCode == '38') {
						socket.emit("onKeyPress", "up");
				    }else if (e.keyCode == '39') {
				    	socket.emit("onKeyPress", "right");
				    }else if (e.keyCode == '40') {
				    	socket.emit("onKeyPress", "down");
				    }
				}
				updateNameButton.onclick=function(){
					welcome.innerHTML = "Welcome "+ updateNameInput.value + "</strong>";
					socket.emit("UpdateUserName", updateNameInput.value);
				};	

			}
		</script>
	</body>
</html>