<!DOCTYPE html>
<html>
	<head>
		<title>Welcome to Sockets i-mo</title>
	</head>
	<body class="main">
		<div id="game-screen">
			<div id="welcome"></div><input id="updateNameInput" placeholder="@whoAreYou?"> <button id="updateNameButton">Update Name</button>
			<hr />
			<div id="users" style="float:right;"></div>
			<canvas id="mo-canvas" width="900" height="600" style="border:1px solid #000000"></canvas>
		</div>
		<!-- Dress up this div and the buttons to make it look like an NES controller -->
		<div id="game-pad" style="display:none;">
			<button id="left">Left</button>
			<button id="right">Right</button>
			<button id="up">Up</button>
			<button id="down">Down</button>
		</div>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"> </script>
		<script type="text/javascript">
			window.onload = function() {
				if( /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
				 //hide pretty much everything but the game pad
				 	$("#game-screen").hide();
				 	$("#game-pad").show();
				 	$("#left").click(function(){
				 		socket.emit("onKeyPress", "left");
				 	});
				 	$("#right").click(function(){
				 		socket.emit("onKeyPress", "right");
				 	});
				 	$("#up").click(function(){
				 		socket.emit("onKeyPress", "up");
				 	});
				 	$("#down").click(function(){
				 		socket.emit("onKeyPress", "down");
				 	});
				}


				function relMouseCoords(event){
				    var totalOffsetX = 0;
				    var totalOffsetY = 0;
				    var canvasX = 0;
				    var canvasY = 0;
				    var currentElement = this;

				    do{
				        totalOffsetX += currentElement.offsetLeft - currentElement.scrollLeft;
				        totalOffsetY += currentElement.offsetTop - currentElement.scrollTop;
				    }
				    while(currentElement = currentElement.offsetParent)

				    canvasX = event.pageX - totalOffsetX;
				    canvasY = event.pageY - totalOffsetY;

				    return {x:canvasX, y:canvasY}
				}
				HTMLCanvasElement.prototype.relMouseCoords = relMouseCoords;

				var c = document.getElementById("mo-canvas");
				var ctx = c.getContext("2d");

				// background image   NOTE: loads after users are drawn so it will hide the users. TODO: add callback
				// var background = new Image();
				// background.src = 'https://s3.amazonaws.com/2014Portfolio/socket-i-mo.png';
		        // background.onload = function() {
		        // 	ctx.drawImage(background, 0, 0, c.width, c.height);
		        // };
		        
		        

				var welcome = document.getElementById("welcome");
				var allUsers = document.getElementById("users");
				var updateNameInput = document.getElementById("updateNameInput");
				var updateNameButton = document.getElementById("updateNameButton");

				var socket = io.connect(window.location.hostname);
				socket.on('welcome', function (data) {
					welcome.innerHTML = "Welcome  <strong>" + data['currentUser'].name + "</strong>";
			        drawUsers(data.users);
			        allUsers.innerHTML = "<strong>Users:</strong><br />" + data.names;
				});
				socket.on('users', function (data) {
					allUsers.innerHTML = "<strong>Users:</strong><br />" + data.names;
					drawUsers(data.users);
				});
				socket.on('userNames', function (data) {
					// console.log("fired");
					// console.log(data.names);
					// allUsers.innerHTML = "<strong>Users:</strong><br />" + data.names;
				});

				socket.on('updateLocation', function (data) {
					drawUsers(data);
				});
				// socket.on('updateNames', function (data) {
				// 	for (var i = 0; i < users.length; i+=1){
				// 		console.log(data[i]);
				// 	}
				// });

				function drawUsers(users){
					//clear canvas
					ctx.clearRect(0, 0, c.width, c.height);
					// ctx.drawImage(background, 0, 0, c.width, c.height);

					for (var i = 0; i < users.length; i+=1){
						ctx.beginPath();
						// ctx.arc(users[i].location.x,users[i].location.y,40,0,2*Math.PI);   <= circle
						ctx.rect(users[i].location.x, users[i].location.y, 50, 50);
						ctx.fillStyle = 'red';
      					ctx.fill();
      					ctx.font = "12px Arial";
						ctx.fillText(users[i].name,users[i].location.x,users[i].location.y);
						// ctx.stroke();
					}
				}

				function mouseMove(event){
					if (timer) clearInterval(timer);
					if (event.which == 1) {
				        coords = c.relMouseCoords(event);
						socket.emit("canvasMouseDown", coords);
					}
				}

				function mouseDown(event){
					 timer=setInterval(function(){
				        coords = c.relMouseCoords(event);
						socket.emit("canvasMouseDown", coords);
				     }, 50);
				}

				var timer;
				c.addEventListener("mousedown", mouseDown);
				c.addEventListener("mousemove", mouseMove);
				c.addEventListener("mouseup", function(){
				    if (timer) clearInterval(timer);
				});			
				document.onkeydown = checkKey;
				function checkKey(e) {
				    e = e || window.event;
				    if (e.keyCode == '37') {
				        socket.emit("onKeyPress", "left");
				    }else if (e.keyCode == '38') {
						socket.emit("onKeyPress", "up");
				    }else if (e.keyCode == '39') {
				    	socket.emit("onKeyPress", "right");
				    }else if (e.keyCode == '40') {
				    	socket.emit("onKeyPress", "down");
				    }
				}
				// document.onkeyup=function(e){console.log(e)};
				updateNameButton.onclick=function(){
					welcome.innerHTML = "Welcome "+ updateNameInput.value + "</strong>";
					socket.emit("UpdateUserName", updateNameInput.value);
				};	
				

			}
		</script>
	</body>
</html>